function isNumeric(e){return!isNaN(parseFloat(e))&&isFinite(e)}var Chat={run:function(e){this.id=e.id,this.checkInterval=e.checkInterval,this.onlineCheckInterval=e.onlineCheckInterval,this.maxLength=e.maxLength,this.ticket=e.ticket,this.activ=!0,this.count=0,document.getElementById("down").style.display="none",document.getElementById("dellButton").style.display="none","Notification"in window&&"denied"!==Notification.permission&&Notification.requestPermission(function(e){"granted"===e&&(window.onfocus=function(){Chat.activ=!0,console.log("onfocus")},window.onblur=function(){Chat.activ=!1,console.log("onblur")})});var t=document.getElementById("msg");t.oninput=function(){Chat.resizeTextarea(t)},Chat.soundNew=new Audio,Chat.soundNew.src="/modules/chat/new.wav",Chat.soundSend=new Audio,Chat.soundSend.src="/modules/chat/send.wav",this.newCheck(),this.newCheckIntervalId=setInterval(function(){Chat.newCheck()},this.checkInterval)},resizeTextarea:function(e){e.style.height="auto",document.getElementById("form").classList.remove("resized"),console.log("remove resized"),e.clientHeight<e.scrollHeight&&(e.style.height=e.scrollHeight+"px",document.getElementById("form").classList.add("resized"),console.log("add resized")),e.scrollHeight>=document.body.clientHeight/3&&(e.style.height=document.body.clientHeight/3+"px",console.log("document.body.clientHeight "+document.body.clientHeight)),console.log("msgTextarea.clientHeight "+e.clientHeight),console.log("msgTextarea.scrollHeight "+e.scrollHeight),console.log("msgTextarea.style.height "+e.style.height)},openListOnline:function(){var e=document.getElementById("loadlistonline"),t=document.getElementById("listonline");e.innerHTML="Загрузка списка",JLoader.request(this.id+"/ajax/online",{responseToId:"loadlistonline",error:function(t){e.innerHTML=t}}),t.style.height="500px"},closeListOnline:function(){var e=document.getElementById("listonline");e.style.height=0},dellCheck:function(){var e=document.querySelectorAll('input[type="checkbox"]:checked'),t=document.getElementById("dellButton");e.length>0?(t.innerHTML="Удалить выделенное ("+e.length+")",t.style.display=""):t.style.display="none"},dell:function(){var e=document.getElementById("dellButton");e.innerHTML="Удаление...";for(var t=new FormData,n=document.querySelectorAll('input[type="checkbox"]:checked'),o=0;o<n.length;++o){t.append(n[o].name,n[o].value);var l=document.getElementById("id"+n[o].value);l.parentNode.removeChild(l)}return t.append("ticket",this.ticket),JLoader.request(this.id+"/ajax/dell",{data:t,success:function(t){e.innerHTML="Error"!=t?"Готово":"Ошибка",setTimeout(function(){Chat.dellCheck()},3e3)},error:function(){e.innerHTML="Ошибка"}}),!1},toUser:function(e){var t=document.getElementById("msg");t.value+="[b]"+e+"[/b], ",t.focus(),t.setSelectionRange(t.value.length,t.value.length)},clear:function(){document.getElementById("msg")&&(document.getElementById("msg").value="",document.getElementById("msg").style.height="auto",document.getElementById("form").classList.remove("resized")),this.report("")},clearChat:function(){document.getElementById("posts")&&(document.getElementById("posts").innerHTML="")},report:function(e){document.getElementById("report")&&(document.getElementById("report").innerHTML=e)},down:function(){document.getElementById("down").style.display="none",this.scroll()},submit:function(){clearTimeout(this.newCheckIntervalId);var e=msg.value,t=setTimeout(function(){Chat.report("Отправка сообщения...")},200);this.scroll();var n=new FormData(document.form);return JLoader.request(this.id+"/ajax/add",{data:n,success:function(n){clearTimeout(t),Chat.clear(),Chat.soundSend.volume=1,Chat.soundSend.play(),"clear"==e.trim().toLowerCase()?Chat.load(0,Chat.scroll):Chat.load(Chat.count,Chat.animatedScroll),isNumeric(n)?Chat.count=n:("Authorized"==n?Chat.report("Вы не авторизованы"):"Strlen"==n?Chat.report("Слишком длинное или короткое сообщение"):"Error"==n?Chat.report("Ошибка при добавлении сообщения"):"Ticket"==n?Chat.report("Ошибка при проверке безопасности"):Chat.report("Неизвестные данные ответа сервера"),msg.value=e),Chat.newCheckIntervalId=setInterval(function(){Chat.newCheck()},Chat.checkInterval)},error:function(n){clearTimeout(t),Chat.report("Произошла ошибка при запросе к серверу"),Chat.newCheckIntervalId=setInterval(function(){Chat.newCheck()},Chat.checkInterval),n.value=e}}),!1},load:function(e,t){0==e&&this.clearChat(),JLoader.request(this.id+"/ajax/loadchat/"+e,{responseToIdAdd:"posts",success:function(n){t(),console.log("load: "+e)}})},scroll:function(){var e=document.body.scrollHeight-document.body.clientHeight;document.documentElement.scrollTop=e,document.body.scrollTop=e,console.log("scroll - "+e)},animatedScroll:function(){var e=document.body.scrollHeight-document.body.clientHeight,t=document.documentElement.scrollTop||document.body.scrollTop;if(e-t<400)var n=setInterval(function(){var t=5;(document.documentElement.scrollTop+t>=e||document.body.scrollTop+t>=e)&&(document.documentElement.scrollTop=e,document.body.scrollTop=e,clearInterval(n)),document.documentElement.scrollTop+=t,document.body.scrollTop+=t,console.log("animatedScroll - "+e)},15);else document.getElementById("down").style.display=""},notify:function(){if(!Chat.activ&&(console.log("notify"),"Notification"in window&&(console.log(Notification.permission),"granted"==Notification.permission))){var e=new Notification("Чат",{tag:"chat",body:"В чате написано новое сообщение",icon:"/modules/chat/notification.png"});e.onclick=function(){window.focus(),this.close()}}},newCheck:function(){console.log("request newCheck"),JLoader.request(Chat.id+"/ajax/newcheck",{success:function(e){console.log("response newCheck: "+e),isNumeric(e)?(Chat.count<e&&(0==Chat.count?Chat.load(Chat.count,Chat.scroll):(Chat.load(Chat.count,Chat.animatedScroll),Chat.soundNew.volume=.8,Chat.soundNew.play()),Chat.notify()),Chat.count>e&&Chat.load(0,Chat.scroll),Chat.count=e,console.log("Chat.count = "+Chat.count)):console.log("response newCheck: no Numeric")}})}};